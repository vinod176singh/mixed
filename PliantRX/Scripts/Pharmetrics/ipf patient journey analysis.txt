create or replace procedure pharmetrics.usp_generate_ipf_universe()
as 
$$
begin
create table pharmetrics.ipf_universe as 
select pat_id ,from_dt ,b.mkted_prod_nm  from pharmetrics.ipf_claims a
inner join pharmetrics.ndc_codes b on a.ndc =b.ndc 
where pat_id in (select pat_id from pharmetrics.ipf_diag id)
and a.ndc in (select distinct ndc from pharmetrics.ndc_codes where prod_custom_lvl1_desc='IPF');
end
$$
language plpgsql;

truncate table pharmetrics.ipf_lot;
copy pharmetrics.ipf_lot from 's3://commdata/CommData/ipf_lot_pharmetrics.csv' 
iam_role 'arn:aws:iam::406431883826:role/Redshift-S3-linkage'
delimiter '|'
TRUNCATECOLUMNS
ACCEPTINVCHARS
IGNOREHEADER  1
region 'us-west-2';

--
--DROP TABLE pharmetrics.ipf_lot;
--CREATE TABLE IF NOT EXISTS pharmetrics.ipf_lot
--(
--	patient_id VARCHAR(256)   ENCODE lzo
--	,svc_dt VARCHAR(256)   ENCODE lzo
--	,mkted_prod_nm VARCHAR(256)   ENCODE lzo
--	,lot varchar(10)   
--)
--DISTSTYLE AUTO
--;
--ALTER TABLE pharmetrics.ipf_lot owner to vsingh;

select * from pharmetrics.ipf_lot;

select max(lot)from pharmetrics.ipf_lot;
select min(lot)from pharmetrics.ipf_lot;

select count(distinct pat_id) from pharmetrics.ipf_diag; 
select count(distinct patient_id) from pharmetrics.ipf_lot;
select prd_cnt,count(distinct patient_id) from(
select distinct patient_id,count(distinct mkted_prod_nm) as prd_cnt from pharmetrics.ipf_lot
group by patient_id
)group by prd_cnt order by 1,2;

select mkted_prod_nm ,count(distinct patient_id) from pharmetrics.ipf_lot
where patient_id in (select distinct patient_id  from pharmetrics.ipf_lot group by patient_id having count(distinct mkted_prod_nm)=1)
group by mkted_prod_nm;

select count(distinct ofev.patient_id) from
(select * from pharmetrics.ipf_lot  where lot=1 and mkted_prod_nm ='OFEV') as  ofev
inner join 
(select * from pharmetrics.ipf_lot  where lot=2 and mkted_prod_nm ='ESBRIET') as Esbriet
on ofev.patient_id =Esbriet.patient_id
--where ofev.patient_id not in (select distinct patient_id  from pharmetrics.ipf_lot group by patient_id having count(distinct mkted_prod_nm)=3);

select count(distinct ofev.patient_id) from
(select * from pharmetrics.ipf_lot  where lot=1 and mkted_prod_nm ='OFEV') as  ofev
inner join 
(select * from pharmetrics.ipf_lot  where lot=2 and mkted_prod_nm ='PIRFENIDONE') as Esbriet
on ofev.patient_id =Esbriet.patient_id
--where ofev.patient_id not in (select distinct patient_id  from pharmetrics.ipf_lot group by patient_id having count(distinct mkted_prod_nm)=3);

select count(distinct ofev.patient_id) from
(select * from pharmetrics.ipf_lot  where lot=1 and mkted_prod_nm ='ESBRIET') as  ofev
inner join 
(select * from pharmetrics.ipf_lot  where lot=2 and mkted_prod_nm ='OFEV') as Esbriet
on ofev.patient_id =Esbriet.patient_id
--where ofev.patient_id not in (select distinct patient_id  from pharmetrics.ipf_lot group by patient_id having count(distinct mkted_prod_nm)=3);

select count(distinct ofev.patient_id) from
(select * from pharmetrics.ipf_lot  where lot=1 and mkted_prod_nm ='ESBRIET') as  ofev
inner join 
(select * from pharmetrics.ipf_lot  where lot=2 and mkted_prod_nm ='PIRFENIDONE') as Esbriet
on ofev.patient_id =Esbriet.patient_id
--where ofev.patient_id not in (select distinct patient_id  from pharmetrics.ipf_lot group by patient_id having count(distinct mkted_prod_nm)=3);

select count(distinct ofev.patient_id) from
(select * from pharmetrics.ipf_lot  where lot=1 and mkted_prod_nm ='PIRFENIDONE') as  ofev
inner join 
(select * from pharmetrics.ipf_lot  where lot=2 and mkted_prod_nm ='OFEV') as Esbriet
on ofev.patient_id =Esbriet.patient_id
where ofev.patient_id not in (select distinct patient_id  from pharmetrics.ipf_lot group by patient_id having count(distinct mkted_prod_nm)=3);

select count(distinct ofev.patient_id) from
(select * from pharmetrics.ipf_lot  where lot=1 and mkted_prod_nm ='PIRFENIDONE') as  ofev
inner join 
(select * from pharmetrics.ipf_lot  where lot=2 and mkted_prod_nm ='ESBRIET') as Esbriet
on ofev.patient_id =Esbriet.patient_id
where ofev.patient_id not in (select distinct patient_id  from pharmetrics.ipf_lot group by patient_id having count(distinct mkted_prod_nm)=3);

select count(distinct ofev.patient_id) from
(select * from pharmetrics.ipf_lot  where lot=1 and mkted_prod_nm ='OFEV') as  ofev
inner join 
(select * from pharmetrics.ipf_lot  where lot=2 and mkted_prod_nm ='ESBRIET') as Esbriet
on ofev.patient_id =Esbriet.patient_id
inner join 
(select * from pharmetrics.ipf_lot  where lot=3 and mkted_prod_nm ='PIRFENIDONE') as pir
on pir.patient_id =Esbriet.patient_id;

select count(distinct ofev.patient_id) from
(select * from pharmetrics.ipf_lot  where lot=1 and mkted_prod_nm ='OFEV') as  ofev
inner join 
(select * from pharmetrics.ipf_lot  where lot=2 and mkted_prod_nm ='PIRFENIDONE') as Esbriet
on ofev.patient_id =Esbriet.patient_id
inner join 
(select * from pharmetrics.ipf_lot  where lot=3 and mkted_prod_nm ='ESBRIET') as pir
on pir.patient_id =Esbriet.patient_id;

select count(distinct ofev.patient_id) from
(select * from pharmetrics.ipf_lot  where lot=1 and mkted_prod_nm ='ESBRIET') as  ofev
inner join 
(select * from pharmetrics.ipf_lot  where lot=2 and mkted_prod_nm ='OFEV') as Esbriet
on ofev.patient_id =Esbriet.patient_id
inner join 
(select * from pharmetrics.ipf_lot  where lot=3 and mkted_prod_nm ='PIRFENIDONE') as pir
on pir.patient_id =Esbriet.patient_id;

select count(distinct ofev.patient_id) from
(select * from pharmetrics.ipf_lot  where lot=1 and mkted_prod_nm ='ESBRIET') as  ofev
inner join 
(select * from pharmetrics.ipf_lot  where lot=2 and mkted_prod_nm ='PIRFENIDONE') as Esbriet
on ofev.patient_id =Esbriet.patient_id
inner join 
(select * from pharmetrics.ipf_lot  where lot=3 and mkted_prod_nm ='OFEV') as pir
on pir.patient_id =Esbriet.patient_id;


select lot,count(distinct patient_id) from pharmetrics.ipf_lot
group by lot order by 1;
