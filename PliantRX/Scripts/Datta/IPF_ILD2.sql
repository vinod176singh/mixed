--Analyze the time it takes to develop IPF after the diagnosis of other ILDs.

create table #temp1 as
select * from pharmetrics.claims c where 
diag_admit in('515','5160','5161','5162','51630','51632','51633','51634','51635','51636','51637','5164','5165','51661','51662','51663','51664','51669','5169','J8489','J8401','J8403','J8402','J84111','J84113','J84114','J84115','J842','J84116','J84117','J8481','J8482','J84841','J84842','J8483','J84843','J84848','J849','M3481','J84170','J8410')
or diag1 in('515','5160','5161','5162','51630','51632','51633','51634','51635','51636','51637','5164','5165','51661','51662','51663','51664','51669','5169','J8489','J8401','J8403','J8402','J84111','J84113','J84114','J84115','J842','J84116','J84117','J8481','J8482','J84841','J84842','J8483','J84843','J84848','J849','M3481','J84170','J8410')
 or diag2 in('515','5160','5161','5162','51630','51632','51633','51634','51635','51636','51637','5164','5165','51661','51662','51663','51664','51669','5169','J8489','J8401','J8403','J8402','J84111','J84113','J84114','J84115','J842','J84116','J84117','J8481','J8482','J84841','J84842','J8483','J84843','J84848','J849','M3481','J84170','J8410')
 or diag3 in('515','5160','5161','5162','51630','51632','51633','51634','51635','51636','51637','5164','5165','51661','51662','51663','51664','51669','5169','J8489','J8401','J8403','J8402','J84111','J84113','J84114','J84115','J842','J84116','J84117','J8481','J8482','J84841','J84842','J8483','J84843','J84848','J849','M3481','J84170','J8410')
 or diag4 in('515','5160','5161','5162','51630','51632','51633','51634','51635','51636','51637','5164','5165','51661','51662','51663','51664','51669','5169','J8489','J8401','J8403','J8402','J84111','J84113','J84114','J84115','J842','J84116','J84117','J8481','J8482','J84841','J84842','J8483','J84843','J84848','J849','M3481','J84170','J8410')
 or diag5 in('515','5160','5161','5162','51630','51632','51633','51634','51635','51636','51637','5164','5165','51661','51662','51663','51664','51669','5169','J8489','J8401','J8403','J8402','J84111','J84113','J84114','J84115','J842','J84116','J84117','J8481','J8482','J84841','J84842','J8483','J84843','J84848','J849','M3481','J84170','J8410')
 or diag6 in('515','5160','5161','5162','51630','51632','51633','51634','51635','51636','51637','5164','5165','51661','51662','51663','51664','51669','5169','J8489','J8401','J8403','J8402','J84111','J84113','J84114','J84115','J842','J84116','J84117','J8481','J8482','J84841','J84842','J8483','J84843','J84848','J849','M3481','J84170','J8410')
 or diag7 in('515','5160','5161','5162','51630','51632','51633','51634','51635','51636','51637','5164','5165','51661','51662','51663','51664','51669','5169','J8489','J8401','J8403','J8402','J84111','J84113','J84114','J84115','J842','J84116','J84117','J8481','J8482','J84841','J84842','J8483','J84843','J84848','J849','M3481','J84170','J8410')
 or diag8 in('515','5160','5161','5162','51630','51632','51633','51634','51635','51636','51637','5164','5165','51661','51662','51663','51664','51669','5169','J8489','J8401','J8403','J8402','J84111','J84113','J84114','J84115','J842','J84116','J84117','J8481','J8482','J84841','J84842','J8483','J84843','J84848','J849','M3481','J84170','J8410')
 or diag9 in('515','5160','5161','5162','51630','51632','51633','51634','51635','51636','51637','5164','5165','51661','51662','51663','51664','51669','5169','J8489','J8401','J8403','J8402','J84111','J84113','J84114','J84115','J842','J84116','J84117','J8481','J8482','J84841','J84842','J8483','J84843','J84848','J849','M3481','J84170','J8410')
 or diag10 in('515','5160','5161','5162','51630','51632','51633','51634','51635','51636','51637','5164','5165','51661','51662','51663','51664','51669','5169','J8489','J8401','J8403','J8402','J84111','J84113','J84114','J84115','J842','J84116','J84117','J8481','J8482','J84841','J84842','J8483','J84843','J84848','J849','M3481','J84170','J8410')
 or diag11 in('515','5160','5161','5162','51630','51632','51633','51634','51635','51636','51637','5164','5165','51661','51662','51663','51664','51669','5169','J8489','J8401','J8403','J8402','J84111','J84113','J84114','J84115','J842','J84116','J84117','J8481','J8482','J84841','J84842','J8483','J84843','J84848','J849','M3481','J84170','J8410')
 or diag12 in('515','5160','5161','5162','51630','51632','51633','51634','51635','51636','51637','5164','5165','51661','51662','51663','51664','51669','5169','J8489','J8401','J8403','J8402','J84111','J84113','J84114','J84115','J842','J84116','J84117','J8481','J8482','J84841','J84842','J8483','J84843','J84848','J849','M3481','J84170','J8410')
group by 1;

select * from #temp1

create table #temp2 as
select distinct pat_id from pharmetrics.ipf_diag id 
except
select a.pat_id from
(select * from #temp1)a
inner join 
pharmetrics.ipf_diag b on a.pat_id=b.pat_id  
where b.min_from_dt  > a.ild_min_dt;

----

create table #ild5 as 
select a.pat_id,a.ild_min_dt,a.max_ild_dt,b.min_from_dt from #temp1 a
inner join 
pharmetrics.ipf_diag b on a.pat_id=b.pat_id  
where b.min_from_dt  > a.ild_min_dt;

select * from #ild4;

select distinct pat_id from #ild5
intersect
select distinct pat_id from #temp3;

select count(distinct a.pat_id) from #ild5 a
inner join 
#temp3 b on a.pat_id=b.pat_id  
where b.min_from_dt  > a.ild_min_dt and a.max_ild_dt > b.min_from_dt;


create table #temp3 as
select a.pat_id,a.min_from_dt,b.ild_min_dt from
(pharmetrics.ipf_diag a
inner join 
(select * from #temp1) b on a.pat_id=b.pat_id  and a.min_from_dt  < b.ild_min_dt);

----------------

select distinct a.pat_id from
(#temp2 a
inner join 
(select * from #temp3) b on a.pat_id=b.pat_id  )

select count(distinct pat_id ) from pharmetrics.claims c 
where ndc in (select distinct ndc from pharmetrics.ndc_codes nc where mkted_prod_nm = 'OFEV')
and   pat_id  in (select distinct pat_id from #temp3); 
---------------------------------------------------------------------------------------------

--4,143 OFEV treated Patients: How many did not have any ILD diagnosis (-+ 0 to 30 days)


select distinct pat_id  from pharmetrics.claims c 
where ndc in (select distinct ndc from pharmetrics.ndc_codes nc where mkted_prod_nm = 'OFEV')
except  
select distinct pat_id  from #temp1; 

------------------
create table #temp4 as
select c.* from pharmetrics.claims c 
inner join 
(select pat_id,min(from_dt) as rx_dt from pharmetrics.claims c 
where ndc in (select distinct ndc from pharmetrics.ndc_codes nc where mkted_prod_nm = 'OFEV') group by 1)b on c.pat_id=b.pat_id
where from_dt between dateadd(day,-30,rx_dt) and dateadd(day,30,rx_dt)


select count(distinct pat_id) from #temp4 where 
diag_admit in('515','5160','5161','5162','51630','51632','51633','51634','51635','51636','51637','5164','5165','51661','51662','51663','51664','51669','5169','J8489','J8401','J8403','J8402','J84111','J84113','J84114','J84115','J842','J84116','J84117','J8481','J8482','J84841','J84842','J8483','J84843','J84848','J849','M3481','J84170','J8410')
or diag1 in('515','5160','5161','5162','51630','51632','51633','51634','51635','51636','51637','5164','5165','51661','51662','51663','51664','51669','5169','J8489','J8401','J8403','J8402','J84111','J84113','J84114','J84115','J842','J84116','J84117','J8481','J8482','J84841','J84842','J8483','J84843','J84848','J849','M3481','J84170','J8410')
 or diag2 in('515','5160','5161','5162','51630','51632','51633','51634','51635','51636','51637','5164','5165','51661','51662','51663','51664','51669','5169','J8489','J8401','J8403','J8402','J84111','J84113','J84114','J84115','J842','J84116','J84117','J8481','J8482','J84841','J84842','J8483','J84843','J84848','J849','M3481','J84170','J8410')
 or diag3 in('515','5160','5161','5162','51630','51632','51633','51634','51635','51636','51637','5164','5165','51661','51662','51663','51664','51669','5169','J8489','J8401','J8403','J8402','J84111','J84113','J84114','J84115','J842','J84116','J84117','J8481','J8482','J84841','J84842','J8483','J84843','J84848','J849','M3481','J84170','J8410')
 or diag4 in('515','5160','5161','5162','51630','51632','51633','51634','51635','51636','51637','5164','5165','51661','51662','51663','51664','51669','5169','J8489','J8401','J8403','J8402','J84111','J84113','J84114','J84115','J842','J84116','J84117','J8481','J8482','J84841','J84842','J8483','J84843','J84848','J849','M3481','J84170','J8410')
 or diag5 in('515','5160','5161','5162','51630','51632','51633','51634','51635','51636','51637','5164','5165','51661','51662','51663','51664','51669','5169','J8489','J8401','J8403','J8402','J84111','J84113','J84114','J84115','J842','J84116','J84117','J8481','J8482','J84841','J84842','J8483','J84843','J84848','J849','M3481','J84170','J8410')
 or diag6 in('515','5160','5161','5162','51630','51632','51633','51634','51635','51636','51637','5164','5165','51661','51662','51663','51664','51669','5169','J8489','J8401','J8403','J8402','J84111','J84113','J84114','J84115','J842','J84116','J84117','J8481','J8482','J84841','J84842','J8483','J84843','J84848','J849','M3481','J84170','J8410')
 or diag7 in('515','5160','5161','5162','51630','51632','51633','51634','51635','51636','51637','5164','5165','51661','51662','51663','51664','51669','5169','J8489','J8401','J8403','J8402','J84111','J84113','J84114','J84115','J842','J84116','J84117','J8481','J8482','J84841','J84842','J8483','J84843','J84848','J849','M3481','J84170','J8410')
 or diag8 in('515','5160','5161','5162','51630','51632','51633','51634','51635','51636','51637','5164','5165','51661','51662','51663','51664','51669','5169','J8489','J8401','J8403','J8402','J84111','J84113','J84114','J84115','J842','J84116','J84117','J8481','J8482','J84841','J84842','J8483','J84843','J84848','J849','M3481','J84170','J8410')
 or diag9 in('515','5160','5161','5162','51630','51632','51633','51634','51635','51636','51637','5164','5165','51661','51662','51663','51664','51669','5169','J8489','J8401','J8403','J8402','J84111','J84113','J84114','J84115','J842','J84116','J84117','J8481','J8482','J84841','J84842','J8483','J84843','J84848','J849','M3481','J84170','J8410')
 or diag10 in('515','5160','5161','5162','51630','51632','51633','51634','51635','51636','51637','5164','5165','51661','51662','51663','51664','51669','5169','J8489','J8401','J8403','J8402','J84111','J84113','J84114','J84115','J842','J84116','J84117','J8481','J8482','J84841','J84842','J8483','J84843','J84848','J849','M3481','J84170','J8410')
 or diag11 in('515','5160','5161','5162','51630','51632','51633','51634','51635','51636','51637','5164','5165','51661','51662','51663','51664','51669','5169','J8489','J8401','J8403','J8402','J84111','J84113','J84114','J84115','J842','J84116','J84117','J8481','J8482','J84841','J84842','J8483','J84843','J84848','J849','M3481','J84170','J8410')
 or diag12 in('515','5160','5161','5162','51630','51632','51633','51634','51635','51636','51637','5164','5165','51661','51662','51663','51664','51669','5169','J8489','J8401','J8403','J8402','J84111','J84113','J84114','J84115','J842','J84116','J84117','J8481','J8482','J84841','J84842','J8483','J84843','J84848','J849','M3481','J84170','J8410')
 
 -------------------------------------------------------------------------------------

--drop table #temp5;

create table #temp5 as 
select * from pharmetrics.claims c2 where pat_id in
(select distinct pat_id  from pharmetrics.claims c 
where ndc in (select distinct ndc from pharmetrics.ndc_codes nc where mkted_prod_nm = 'OFEV')
except 
select pat_id  from #temp1); 

select * into #temp6 from
(select b.* from (
(select pat_id,min(distinct from_dt) as rx_dt from pharmetrics.claims c 
where ndc in (select distinct ndc from pharmetrics.ndc_codes nc where mkted_prod_nm = 'OFEV') group by 1)c
inner join 
(select * from #temp5)b on c.pat_id =b.pat_id and c.rx_dt =b.from_dt))

--select * from #temp6 order by 1 desc

select distinct diag_admit ,count(distinct pat_id)from(
SELECT distinct pat_id,diag_admit FROM #temp5
UNION 
SELECT  distinct pat_id,diag1 FROM #temp5
UNION 
SELECT  distinct pat_id,diag2 FROM #temp5
UNION 
SELECT distinct pat_id,diag3 FROM #temp5
UNION 
SELECT  distinct pat_id,diag4 FROM #temp5
UNION 
SELECT distinct pat_id,diag5 FROM #temp5
UNION 
SELECT distinct pat_id,diag6 FROM #temp5
UNION 
SELECT distinct pat_id,diag7 FROM #temp5
UNION 
SELECT distinct pat_id,diag8 FROM #temp5
UNION 
SELECT distinct pat_id,diag9 FROM #temp5
UNION 
SELECT distinct pat_id,diag10 FROM #temp5
UNION 
SELECT  distinct pat_id,diag11 FROM #temp5
UNION 
SELECT  distinct pat_id,diag12 FROM #temp5) group by 1 order by 2 desc;

------------------------------------------------------------------
--ILD_IPF_ILD
select count(distinct a.pat_id) from #temp1 a
inner join 
pharmetrics.ipf_diag b on a.pat_id=b.pat_id  
where b.min_from_dt  > a.ild_min_dt and a.max_ild_dt > b.min_from_dt;

select * from #ild5

--IPF_ILD_IPF
create table #ipf1 as
select distinct pat_id,min(from_dt) as min_diag_dt,max(from_dt) as max_diag_dt from pharmetrics.claims WHERE  
('51631' IN (diag_admit, diag1, diag2, diag3,diag4,diag5,diag6 ,diag7,diag8,diag9,diag10,diag11,diag12) 
OR 'J84112' IN (diag_admit,diag1, diag2, diag3,diag4,diag5,diag6 ,diag7,diag8,diag9,diag10,diag11,diag12)) group by 1

select count(distinct a.pat_id) from #ipf1 b
inner join 
#temp1 a on a.pat_id=b.pat_id  
where b.min_diag_dt  < a.ild_min_dt and b.max_diag_dt > a.ild_min_dt;


